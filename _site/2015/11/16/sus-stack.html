<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title></title>
  <style type="text/css">
  body
  {
    margin:40px auto;
    max-width:680px;
    line-height:1.4;
    font-size:120%;
    color:#111;
    padding:0 10px;
    background-color: #FDFDFD;
  }

  a{
    text-decoration: none;
    color: cornflowerblue;
  }

  a:hover{
    text-decoration: underline;
  }

  h1,h2,h3
  {
    line-height:1.2;
  }

  article{
    margin-top:200px;
  }
  .caption{
    width:100%;
  }
  .centered{
    margin:0 auto;
    display:block;
  }

  code{
    font-size:1em;
    white-space: pre;
    background-color:ghostwhite;
    display:block;
    overflow: auto;
    padding: 0.6em 0.8em;
  }


  </style>
</head>

  
  <body>
  
  <div class="container content">
      <header class="masthead">
        <h2 class="masthead-title">
          <a href="/" title="Home">Steven LoFurno</a>
          
             
              &nbsp;&nbsp;&nbsp;
              <small><a href="/about">About</a></small>
            
              &nbsp;&nbsp;&nbsp;
              <small><a href="/">Posts</a></small>
            
              &nbsp;&nbsp;&nbsp;
              <small><a href="/projects">Projects</a></small>
            
        </h2>
        <small>a programming blog by a retired pro-gamer</small>
      </header>
      
    <main>
        <article>
  <h1 class="post-title">distributed systems with libmill and nanomsg</h1>
  <time datetime="2015-11-16T00:00:00-05:00" class="post-date">16 Nov 2015</time>
  <p>In this post I’m going to give an introduction to using the Sústrik stack for developing high performance distributed systems. While both libraries have been out in beta for a couple years, they are becoming stable. libmill recently hit version 1.0, and according to Garrett D’Amore, the top contributer to nanomsg, we may be only a few weeks from a version 1.0 release of nanomsg.</p>

<p>Libmill is a c library for working with coroutines in a style that is simliar to golang, complete with a syntactically similiar version of channels, select statements, and goroutines.</p>

<p>Nanomsg is the reference implementation of the scalability protocols, a composable layer on top of the underlying sockets which makes it simple to develop robust distributed systems.</p>

<p>While you can use them separately, together they show alot of synergy. Libmill operates in the context of a single thread, so you need to avoid blocking. To make this possible, libmill provides nonblocking versions of io functions like reading from a file or sleeping. Nanomsg provides a flag to allow for either blocking or non blocking io calls. Since we don’t want to block the thread, we can ask nanomsg for a file descripter which will signal when there is data available. We can combine this with libmill’s wait to yield our goroutine until  there is data to be read.</p>

<p>Below is a more conrete example, implementing the subscribe side of the pub-sub pattern. Notice the coroutine keyword, a decorator that libmill uses to indicate a function that will be ran as a coroutine. When we set the topic as “nanomsg”, we will receive any message which has a matching prefix, for example “nanomsg :D”.</p>

<pre><code>coroutine void subscribe()
{
  int subscriber = nn_socket(AF_SP,NN_SUB);
  char *buffer= NULL;
  char *topic= "nanomsg";
  int fd;
  size_t fd_sz = sizeof(fd);

  //subscribe to topic "nanomsg"
  nn_setsockopt(subscriber,NN_SUB,NN_SUB_SUBSCRIBE, topic, strlen(topic));

  nn_connect(  
    nn_setsockopt(subscriber,"tcp://127.0.0.1:1234");

  //get the file descripter which signals when we should read
  nn_getsockopt(subscriber,NN_SOL_SOCKET,NN_RCVFD,&amp;fd,&amp;fd_sz);

  //libmill waits until the socket has data to be read
  fdwait(fd,FDW_IN,-1);
  //using the NN_MSG flag, we let nanomsg allocate the buffer
  size_t nbytes = nn_recv(subscriber,&amp;buffer,NN_MSG,NN_DONTWAIT);

  printf("%s",buffer);
  nn_freemsg(buffer);
}
</code></pre>

</article>

    </main>
    
   </div>
   
   <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-68120130-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>